---
import jobsData from "@/data/jobs.json";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Breadcrumb from "@/components/Breadcrumb.astro";
import JobCard from "@/components/JobCard.astro";
import Layout from "./Layout.astro";
import { SITE } from "@/config";

export interface Props {
  frontmatter: {
    title: string;
    description?: string;
  };
}

const { frontmatter } = Astro.props;

// Get jobs from the JSON file
const allJobs = jobsData.jobs || [];

// Sort jobs by title (or you could add a date field and sort by that)
const sortedJobs = allJobs.sort((a, b) => a.title.localeCompare(b.title));

// Extract unique locations, companies, and employment types for filters
const uniqueLocations = [...new Set(allJobs.map(job => job.location).filter(Boolean))].sort();
const uniqueCompanies = [...new Set(allJobs.map(job => job.company).filter(Boolean))].sort();
const uniqueEmploymentTypes = [...new Set(allJobs.map(job => job.employmentType).filter(Boolean))].sort();

// Extract years values and find min/max for the filter
const yearsValues = allJobs
  .map(job => {
    if (!job.years) return null;
    const match = job.years.match(/(\d+)/);
    return match ? parseInt(match[1]) : null;
  })
  .filter((years): years is number => years !== null);

const minYears = yearsValues.length > 0 ? Math.min(...yearsValues) : 0;
const maxYears = yearsValues.length > 0 ? Math.max(...yearsValues) : 0;
---

<Layout title={`${frontmatter.title} | ${SITE.title}`}>
  <Header />
  <Breadcrumb />
  <main id="main-content">
    <section id="jobs" class="app-prose mb-28 max-w-app">
      <h1 class="text-2xl tracking-wider sm:text-3xl">{frontmatter.title}</h1>
      {frontmatter.description && (
        <p class="mt-4 text-muted">{frontmatter.description}</p>
      )}
      <slot />
      
      {sortedJobs.length > 0 ? (
        <>
          <!-- Filter Controls -->
          <div class="mt-8 mb-6 w-fit p-2">
            <h2 class="mb-2 text-sm font-semibold">Filter Jobs</h2>
            <div class="flex flex-col flex-wrap gap-4 sm:flex-row sm:gap-6">
              <div>
                <label for="filter-location" class="block mb-0.5 text-xs font-medium">
                  Location
                </label>
                <select
                  id="filter-location"
                  class="min-w-[18ch] w-auto rounded border border-border bg-background px-2 py-1 text-xs text-foreground focus:outline focus:outline-2 focus:outline-accent"
                >
                  <option value="">All Locations</option>
                  {uniqueLocations.map(location => (
                    <option value={location}>{location}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label for="filter-company" class="block mb-0.5 text-xs font-medium">
                  Company
                </label>
                <select
                  id="filter-company"
                  class="min-w-[18ch] w-auto rounded border border-border bg-background px-2 py-1 text-xs text-foreground focus:outline focus:outline-2 focus:outline-accent"
                >
                  <option value="">All Companies</option>
                  {uniqueCompanies.map(company => (
                    <option value={company}>{company}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label for="filter-employment-type" class="block mb-0.5 text-xs font-medium">
                  Employment Type
                </label>
                <select
                  id="filter-employment-type"
                  class="min-w-[18ch] w-auto rounded border border-border bg-background px-2 py-1 text-xs text-foreground focus:outline focus:outline-2 focus:outline-accent"
                >
                  <option value="">All Types</option>
                  {uniqueEmploymentTypes.map(type => (
                    <option value={type}>{type}</option>
                  ))}
                </select>
              </div>
              
              <div>
                <label for="filter-years" class="block mb-0.5 text-xs font-medium">
                  Experience Level
                </label>
                <select
                  id="filter-years"
                  class="min-w-[18ch] w-auto rounded border border-border bg-background px-2 py-1 text-xs text-foreground focus:outline focus:outline-2 focus:outline-accent"
                >
                  <option value="">Any Level</option>
                  <option value="entry">Entry (0-2 years)</option>
                  <option value="senior">Senior (3-5 years)</option>
                  <option value="lead">Lead (5+ years)</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Jobs List -->
          <ul id="jobs-list" class="list-none">
            {sortedJobs.map(job => (
              <li
                class="job-item"
                data-location={job.location || ''}
                data-company={job.company || ''}
                data-employment-type={job.employmentType || ''}
                data-years={(() => {
                  if (!job.years) return '';
                  const match = job.years.match(/(\d+)/);
                  const years = match ? parseInt(match[1]) : null;
                  if (years === null) return '';
                  if (years <= 2) return 'entry';
                  if (years >= 3 && years <= 5) return 'senior';
                  if (years > 5) return 'lead';
                  return '';
                })()}
              >
                <JobCard job={job} />
              </li>
            ))}
          </ul>
          
          <!-- No Results Message -->
          <p id="no-results" class="mt-8 text-muted hidden">No jobs match your filters.</p>
        </>
      ) : (
        <p class="mt-8 text-muted">Check back soon for new listings!</p>
      )}
    </section>
  </main>
  <Footer />
</Layout>

<script is:inline>
  function filterJobs() {
    const locationFilter = document.getElementById('filter-location')?.value || '';
    const companyFilter = document.getElementById('filter-company')?.value || '';
    const employmentTypeFilter = document.getElementById('filter-employment-type')?.value || '';
    const yearsFilter = document.getElementById('filter-years')?.value || '';
    
    const jobItems = document.querySelectorAll('.job-item');
    const noResults = document.getElementById('no-results');
    let visibleCount = 0;
    
    jobItems.forEach(item => {
      const location = item.getAttribute('data-location') || '';
      const company = item.getAttribute('data-company') || '';
      const employmentType = item.getAttribute('data-employment-type') || '';
      const years = item.getAttribute('data-years') || '';
      
      // Normalize/trim/compare ignoring whitespace/case for reliability
      const norm = str => (str || '').trim().toLowerCase();
      const matchesLocation = !locationFilter || norm(location) === norm(locationFilter);
      const matchesCompany = !companyFilter || norm(company) === norm(companyFilter);
      const matchesEmploymentType = !employmentTypeFilter || norm(employmentType) === norm(employmentTypeFilter);
      // Experience Level filter is inactive for now
      const matchesYears = true;
      
      // Debug: log the comparison values and result
      console.log('[FILTER DEBUG]', {
        location_raw: location,
        locationFilter_raw: locationFilter,
        location_matched: matchesLocation,
        company_raw: company,
        companyFilter_raw: companyFilter,
        company_matched: matchesCompany,
        employmentType_raw: employmentType,
        employmentTypeFilter_raw: employmentTypeFilter,
        employmentType_matched: matchesEmploymentType
      });
      
      if (matchesLocation && matchesCompany && matchesEmploymentType && matchesYears) {
        item.style.display = '';
        visibleCount++;
      } else {
        item.style.display = 'none';
      }
    });
    
    if (noResults) {
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }
  }
  
  // Add event listeners to filter controls
  document.addEventListener('astro:page-load', () => {
    const locationSelect = document.getElementById('filter-location');
    const companySelect = document.getElementById('filter-company');
    const employmentTypeSelect = document.getElementById('filter-employment-type');
    const yearsSelect = document.getElementById('filter-years');
    
    locationSelect?.addEventListener('change', filterJobs);
    companySelect?.addEventListener('change', filterJobs);
    employmentTypeSelect?.addEventListener('change', filterJobs);
    yearsSelect?.addEventListener('change', filterJobs);
    
    // Initial filter on page load
    filterJobs();
  });
  
  // Also run on initial load
  filterJobs();
</script>
